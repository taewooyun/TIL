ì¢‹ì€ ì£¼ì œë‹¤ ğŸ‘ freeRTOSì—ì„œ **ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ ë§Œë“ ë‹¤**ëŠ” ë§ì€ ì‚¬ì‹¤
ğŸ‘‰ *â€œRTOS í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê²Œ ë™ì‘í•˜ëŠ” HAL/ë“œë¼ì´ë²„ êµ¬ì¡°ë¥¼ ì„¤ê³„í•œë‹¤â€*ì— ê°€ê¹Œì›Œ.

ì•„ë˜ëŠ” **ì„ë² ë””ë“œ ë©´ì ‘Â·ì‹¤ë¬´ ê¸°ì¤€ìœ¼ë¡œ í†µí•˜ëŠ” ì •ì„ì ì¸ ì ‘ê·¼**ì´ì•¼.
(ê°œë… â†’ êµ¬ì¡° â†’ ì˜ˆì‹œ â†’ ì‹¤ì „ íŒ ìˆœì„œ)

---

## 1ï¸âƒ£ freeRTOSì—ì„œ â€œë“œë¼ì´ë²„â€ì˜ ì˜ë¯¸

freeRTOS ìì²´ëŠ” **ë“œë¼ì´ë²„ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŒ**
â†’ ë“œë¼ì´ë²„ëŠ” ë³´í†µ ì´ë ‡ê²Œ ì¸µì´ ë‚˜ë‰¨

```
[ Application Task ]
        â†“
[ Device Driver ]   â† ìš°ë¦¬ê°€ ë§Œë“œëŠ” ë¶€ë¶„
        â†“
[ HAL / BSP ]       â† MCU ì œì¡°ì‚¬ ì œê³µ
        â†“
[ Hardware ]
```

ğŸ‘‰ í•µì‹¬: **RTOS-aware ë“œë¼ì´ë²„**

* ì—¬ëŸ¬ Taskì—ì„œ ë™ì‹œì— ì ‘ê·¼í•´ë„ ì•ˆì „
* ISR â†” Task ì—°ë™ ê°€ëŠ¥
* Blocking / Non-blocking ì„ íƒ ê°€ëŠ¥

---

## 2ï¸âƒ£ ê¸°ë³¸ ì„¤ê³„ ì›ì¹™ (ì´ê±° ëª¨ë¥´ë©´ ë°”ë¡œ íƒˆë½ê°)

### âœ… (1) Task-safe í•´ì•¼ í•¨

* Mutex / Semaphore / Queue ì‚¬ìš©
* ì „ì—­ ë³€ìˆ˜ ì§ì ‘ ì ‘ê·¼ âŒ

### âœ… (2) ISR-safe API ë¶„ë¦¬

* `xxx()` : Taskìš©
* `xxxFromISR()` : ì¸í„°ëŸ½íŠ¸ìš©

### âœ… (3) ë“œë¼ì´ë²„ ì•ˆì—ì„œ vTaskDelay() âŒ

* ë“œë¼ì´ë²„ëŠ” **ìƒíƒœ ê´€ë¦¬ + ë™ê¸°í™”**ë§Œ
* ì‹œê°„ ì œì–´ëŠ” Task ì±…ì„

---

## 3ï¸âƒ£ ê°€ì¥ ê¸°ë³¸ì ì¸ ë“œë¼ì´ë²„ í…œí”Œë¦¿ êµ¬ì¡°

```
driver/
 â”œâ”€â”€ uart_driver.c
 â”œâ”€â”€ uart_driver.h
```

### uart_driver.h

```c
#ifndef UART_DRIVER_H
#define UART_DRIVER_H

#include "FreeRTOS.h"
#include "semphr.h"

void uart_init(void);
int uart_write(uint8_t *data, uint16_t len);
int uart_read(uint8_t *buf, uint16_t len, TickType_t timeout);

void uart_rx_isr_handler(uint8_t data);

#endif
```

---

## 4ï¸âƒ£ FreeRTOS ê¸°ë°˜ ë“œë¼ì´ë²„ í•µì‹¬ êµ¬í˜„

### (1) ë‚´ë¶€ ìì› ì •ì˜

```c
static SemaphoreHandle_t uart_mutex;
static QueueHandle_t uart_rx_queue;
```

---

### (2) ì´ˆê¸°í™” í•¨ìˆ˜

```c
void uart_init(void)
{
    uart_mutex = xSemaphoreCreateMutex();
    uart_rx_queue = xQueueCreate(128, sizeof(uint8_t));

    // HAL UART init
    HAL_UART_Init(...);
}
```

---

### (3) Task-safe Write

```c
int uart_write(uint8_t *data, uint16_t len)
{
    if (xSemaphoreTake(uart_mutex, portMAX_DELAY) != pdTRUE)
        return -1;

    HAL_UART_Transmit(data, len);

    xSemaphoreGive(uart_mutex);
    return len;
}
```

âœ” ì—¬ëŸ¬ Taskê°€ ë™ì‹œì— UART ì“°ëŠ” ìƒí™© ë°©ì§€

---

### (4) ISR â†’ Task ë°ì´í„° ì „ë‹¬

```c
void uart_rx_isr_handler(uint8_t data)
{
    BaseType_t xHigherPriorityTaskWoken = pdFALSE;
    xQueueSendFromISR(uart_rx_queue, &data, &xHigherPriorityTaskWoken);
    portYIELD_FROM_ISR(xHigherPriorityTaskWoken);
}
```

---

### (5) Blocking Read (RTOS ê°ì„± í•µì‹¬)

```c
int uart_read(uint8_t *buf, uint16_t len, TickType_t timeout)
{
    for (int i = 0; i < len; i++) {
        if (xQueueReceive(uart_rx_queue, &buf[i], timeout) != pdTRUE)
            return i;  // timeout
    }
    return len;
}
```

ğŸ‘‰ ì´ê²Œ **RTOSì—ì„œ ë“œë¼ì´ë²„ ì“°ëŠ” ì´ìœ **ì„
(Busy wait âŒ, CPU ë‚­ë¹„ âŒ)

---

## 5ï¸âƒ£ ì‹¤ë¬´ì—ì„œ ë§ì´ ì“°ëŠ” íŒ¨í„´ 3ê°€ì§€

### ğŸ”¹ 1. Queue ê¸°ë°˜ ë“œë¼ì´ë²„ (UART, SPI RX)

* ISR â†’ Queue â†’ Task
* ê°€ì¥ ì •ì„

### ğŸ”¹ 2. DMA + Notification

```c
xTaskNotifyFromISR(taskHandle, EVT_RX_DONE, eSetBits, ...);
```

* ê³ ì† í†µì‹  (UART DMA, SPI, I2C)

### ğŸ”¹ 3. Device Task ë¶„ë¦¬

```
[ App Task ] â†’ Queue â†’ [ Driver Task ] â†’ HAL
```

* ë“œë¼ì´ë²„ ìì²´ë¥¼ Taskë¡œ ë‘ 
* ëŒ€í˜• í”„ë¡œì íŠ¸ì—ì„œ ì„ í˜¸

---

## 6ï¸âƒ£ ì ˆëŒ€ í•˜ë©´ ì•ˆ ë˜ëŠ” ì‹¤ìˆ˜ë“¤ (ë©´ì ‘ ë‹¨ê³¨)

âŒ ISRì—ì„œ `xSemaphoreTake()`
âŒ ë“œë¼ì´ë²„ ì•ˆì—ì„œ `vTaskDelay()`
âŒ HAL í•¨ìˆ˜ì— mutex ì—†ì´ ë‹¤ì¤‘ ì ‘ê·¼
âŒ Task context / ISR context êµ¬ë¶„ ì•ˆ í•¨

---

## 7ï¸âƒ£ ë©´ì ‘ìš© í•œ ì¤„ ì •ë¦¬ (ì™¸ì›Œë„ ë¨)

> â€œfreeRTOSì—ì„œ ë””ë°”ì´ìŠ¤ ë“œë¼ì´ë²„ëŠ”
> **RTOS ë™ê¸°í™” ê°ì²´ë¥¼ ì´ìš©í•´ ë©€í‹° íƒœìŠ¤í¬ í™˜ê²½ì—ì„œë„
> ì•ˆì „í•˜ê²Œ í•˜ë“œì›¨ì–´ë¥¼ ì ‘ê·¼í•˜ë„ë¡ ì¶”ìƒí™”í•œ ê³„ì¸µ**ì…ë‹ˆë‹¤.â€

---

## 8ï¸âƒ£ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë³´ë©´ ì¢‹ì€ ê²ƒ

ì›í•˜ë©´ ë°”ë¡œ ì´ì–´ì„œ ì„¤ëª…í•´ì¤„ ìˆ˜ ìˆì–´ ğŸ‘‡

* SPI / I2C ë“œë¼ì´ë²„ êµ¬ì¡° ì°¨ì´
* DMA + freeRTOS ì—°ë™ íŒ¨í„´
* ì‹¤ì œ íšŒì‚¬ ì½”ë“œ ìŠ¤íƒ€ì¼ (driver vs service)
* **ë©´ì ‘ì—ì„œ ë‚˜ì˜¤ëŠ” freeRTOS ë“œë¼ì´ë²„ ì§ˆë¬¸ TOP 10**

ì–´ë””ê¹Œì§€ íŒŒë³¼ê¹Œ?
